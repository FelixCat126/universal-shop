# 📋 Universal Shop 更新日志

## 2024年更新记录

### 🔧 系统全面优化与修复 (v1.2)
**日期**: 2024年12月

#### 🆕 **核心功能完善**
- ✅ **推荐码系统完全修复**
  - 修复游客下单时推荐码无法写入注册信息的问题
  - 统一游客自动注册与正常注册的业务逻辑，消除代码重复
  - 推荐码支持自由填写，无需验证系统中是否存在
  - 修复用户注册时 `normalizedReferralCode` 未定义导致的500错误

- ✅ **订单地址系统全面优化**
  - 为订单表添加 `province`, `city`, `district`, `postal_code` 字段
  - 登录用户下单自动从地址表获取完整地址信息
  - 修复 `delivery_address` 字段缺少邮编的问题（登录用户和游客用户）
  - 优化地址信息组装逻辑，确保数据完整性

- ✅ **购物车多商品支持**
  - 修复购物车表错误的 `UNIQUE` 约束导致无法添加多种商品的问题
  - 重构购物车数据库约束，只保留 `user_id` + `product_id` 的复合唯一索引
  - 支持同一用户添加多种不同商品到购物车

- ✅ **订单状态国际化**
  - 订单导出功能支持三语言格式（泰文（中文、英文））
  - 完善管理后台导出功能的本地化支持

#### 🔧 **系统架构优化**
- ✅ **数据库智能管理**
  - 实现开箱即用的数据库初始化系统
  - 智能检测和修复错误的数据库约束
  - 修改 `sequelize.sync()` 策略，避免 `alter: true` 导致的约束错误
  - 购物车表约束自动检测修复，确保系统稳定性

- ✅ **开发体验提升**
  - 配置 Nodemon 实现服务器代码热重载
  - 创建 `nodemon.json` 配置文件，优化开发环境
  - 修改 `dev:server` 脚本支持自动重启
  - 热重载配置不影响生产环境部署

- ✅ **API路由优化**
  - 修复 `/api/health` 健康检查端点的路由顺序问题
  - 确保健康检查在404处理之前正确响应
  - 优化API错误处理和日志记录

#### 🧹 **代码质量提升**
- ✅ **业务逻辑统一**
  - 重构用户注册相关代码，创建统一的 `_createUserCore` 方法
  - `autoRegister` 和 `register` 复用核心注册逻辑
  - 新增 `createUserForOrder` 专用于订单创建时的用户注册
  - 消除代码重复，提高可维护性

- ✅ **调试信息清理**
  - 移除所有临时调试 `console.log` 语句
  - 清理地址表单重置和区域变更的调试输出
  - 保留必要的系统日志（数据库连接、服务启动等）
  - 代码整洁性大幅提升

#### 📋 **技术实现细节**
- **前端文件变更**:
  - `src/portal/views/cart/Checkout.vue`: 优化订单提交逻辑和地址组装
  - `src/portal/views/Profile.vue`: 清理地址管理调试信息

- **后端文件变更**:
  - `src/server/controllers/orderController.js`: 完善订单创建和地址处理逻辑
  - `src/server/controllers/userController.js`: 统一用户注册业务逻辑
  - `src/server/controllers/exportController.js`: 添加三语言订单状态支持
  - `src/server/models/Order.js`: 添加地址相关字段
  - `src/server/app.js`: 优化数据库同步策略和API路由
  - `src/server/seeds/index.js`: 实现智能数据库同步和约束修复

- **配置文件变更**:
  - `package.json`: 修改开发脚本支持热重载
  - `nodemon.json`: 新增热重载配置文件

#### 🎯 **修复问题列表**
1. ❌ ➜ ✅ 游客下单推荐码无法写入用户信息
2. ❌ ➜ ✅ 用户注册时 `normalizedReferralCode is not defined` 错误
3. ❌ ➜ ✅ 管理端订单加载失败
4. ❌ ➜ ✅ 数据库同步验证错误导致启动失败
5. ❌ ➜ ✅ 登录用户下单省市区邮编字段未填充
6. ❌ ➜ ✅ 购物车添加第二种商品时约束错误
7. ❌ ➜ ✅ 订单 `delivery_address` 缺少邮编信息
8. ❌ ➜ ✅ 开发环境不支持热重载

#### 🚀 **性能与稳定性**
- 系统启动更加稳定，数据库初始化完全自动化
- 开发效率显著提升，支持代码热重载
- 购物车功能完全正常，支持多商品操作
- 订单系统健壮性大幅提升，地址信息完整准确
- 推荐码系统功能完善，支持业务推广需求

### 🎁 推荐码结算功能
**日期**: 2024-01-XX

#### 🆕 **新功能实现**
- ✅ **结算页面推荐码输入**
  - 在非登录用户结算页面添加推荐码填写字段（可选）
  - 支持多语言界面显示和提示文本
  - 用户友好的UI设计，明确标注可选性质

- ✅ **自动注册推荐码支持**
  - 更新订单控制器接收推荐码参数
  - 修改自动注册逻辑，支持推荐码传递和保存
  - 确保推荐码正确关联到新创建的用户账户

- ✅ **国际化支持**
  - 添加推荐码相关的中文、英文、泰文翻译
  - 包括字段标签、占位符、提示信息等完整翻译

#### 📋 **技术实现**
- 前端：`src/portal/views/cart/Checkout.vue` 添加推荐码输入字段
- 后端：`src/server/controllers/orderController.js` 支持推荐码传递
- 后端：`src/server/controllers/userController.js` 自动注册支持推荐码
- 国际化：更新 `zh-CN.js`、`en-US.js`、`th-TH.js` 翻译文件

#### 🐛 **问题修复**
- ✅ **手机号显示优化**
  - 修复登录用户地址选择页面手机号缺少国家区号的显示问题
  - 确保订单创建时正确存储完整手机号（含区号）
  - 优化游客用户自动注册时地址创建的国家区号解析

- ✅ **手机号验证逻辑修复**
  - 修复非登录用户订单提交时手机号长度验证错误
  - 更新验证规则：中国/泰国不少于11位，马来西亚不少于9位
  - 统一所有相关模块的手机号验证逻辑（订单、用户、地址）
  - 正确解析和验证包含国家区号的完整手机号

- ✅ **管理员登录修复**
  - 修复管理员登录问题，确保超级管理员密码始终为123456
  - 更新种子系统，每次运行时强制重置admin密码为123456
  - 保证系统初始化后管理员账户始终可用

- ✅ **管理端国际化修复**
  - 修复英文环境下登录错误提示仍显示中文的问题
  - 统一使用前端国际化文本，不依赖后端返回的中文消息
  - 确保所有错误提示和表单验证消息正确国际化

### 🚀 开箱即用部署优化
**日期**: 2024-01-XX

#### 主要改进
- ✅ **数据库自动初始化**
  - 修改 `sequelize.sync({ alter: true })` 确保表结构自动创建和更新
  - 新安装时自动创建所有必要的数据库表

- ✅ **数据种子系统**
  - 创建 `src/server/seeds/` 目录和完整的种子系统
  - 自动创建默认管理员账户 (admin/123456)
  - 导出并固化完整泰国行政区数据 (8437条记录：77省份+920市区+7440子区)
  - 分批导入机制，避免内存问题
  - 支持 `npm run setup` 和 `npm run seed` 命令

- ✅ **项目文件清理**
  - 移除不必要的临时脚本和迁移文件
  - 清理 migrations 目录
  - 统一使用数据种子系统

#### 技术实现
- 🔧 **DataSeeder 类**：统一管理所有初始化数据
- 📁 **种子文件结构**：`seeds/index.js` + `seeds/thailandRegions.js`
- 🎯 **开箱即用**：`npm install` → `npm run setup` → `npm run dev`

### 🌍 国际化功能优化
**日期**: 2024-01-XX

#### 主要功能
- ✅ **泰国地址三级联动选择器**
  - 新增省市区三级联动地址选择功能
  - 支持泰语/英语双语显示
  - 自动填入邮编功能
  - 数据库存储77个省份、920个市区、7440个子区

- ✅ **管理端用户地址查看**
  - 管理端用户详情页新增地址信息显示
  - 支持查看用户所有收货地址
  - 显示地址类型、默认地址标识
  - 完整的国际化支持（中英泰三语）

- ✅ **用户管理界面优化**
  - 用户列表页显示推荐人信息
  - 用户详情页显示推荐人（不显示用户自己的推荐码）
  - 统一下拉菜单高度
  - 移除重复的邮编输入字段

#### 技术改进
- 🔧 **后端API增强**
  - 新增 `/api/administrative-regions/*` 行政区域API
  - 新增 `/api/admin/users/:userId/addresses` 管理员查看用户地址API
  - 优化用户注册时推荐码处理逻辑

- 🎨 **前端组件**
  - 新增 `ThailandAddressSelector` 三级联动组件
  - 新增 `CountryFlag` 国旗显示组件
  - 优化 `CountrySelector` 组件样式

- 🗄️ **数据库结构**
  - 新增 `administrative_regions` 表
  - 完善地址表 `addresses` 的邮编字段

#### 国际化完善
- 🇨🇳 中文：完整支持
- 🇺🇸 英文：完整支持  
- 🇹🇭 泰语：新增地址相关翻译，修复管理端国际化问题

#### 文件清理
- 🧹 清理临时文档和脚本文件
- 📁 统一更新日志到 `docs/CHANGELOG.md`

---

## 📝 更新说明

### 如何记录新的更新

当进行新的功能开发或修复时，请在此文件中添加相应的记录：

```markdown
### 🚀 [功能名称]
**日期**: YYYY-MM-DD

#### 主要变更
- ✅ 功能A：描述
- 🔧 修复B：描述
- 🎨 优化C：描述

#### 技术细节
- 修改的文件列表
- 新增的API接口
- 数据库变更

#### 影响范围
- 前端页面影响
- 后端API影响
- 数据库影响
```

### 更新类型图标说明

- ✅ 新功能
- 🔧 修复/改进
- 🎨 UI/样式优化
- 🗄️ 数据库变更
- 🌍 国际化
- 🧹 清理/重构
- 📝 文档更新
- 🚀 性能优化
- 🔒 安全更新

---

**📌 注意**: 此文件应持续更新，记录所有重要的功能变更和修复。
