# Universal Shop 系统架构文档

## 1. 项目概述

Universal Shop 是一个轻量化的全栈电商系统，采用现代化的前后端分离架构，支持多语言（中文/英语/泰语），专为快速部署和易于维护而设计。

### 1.1 核心特性
- 🚀 **快速部署**: 支持一键安装和部署
- 🌐 **多语言支持**: 内置中文/英语/泰语三种语言
- 📱 **响应式设计**: 移动优先的用户界面
- 🔐 **完善的权限系统**: 多角色管理员权限控制
- 🛡️ **安全可靠**: HTTPS支持、JWT认证、密码加密
- ☁️ **云部署优化**: 特别适配阿里云等云服务器

### 1.2 技术栈概览

| 层级 | 技术栈 | 说明 |
|------|--------|------|
| 前端框架 | Vue 3 + Vite | 现代化前端开发体验 |
| UI组件库 | Element Plus + Tailwind CSS | 丰富的组件生态 |
| 状态管理 | Pinia | Vue 3推荐的状态管理方案 |
| 后端框架 | Node.js + Express | 轻量级高性能服务器 |
| ORM框架 | Sequelize | 支持多种数据库的ORM |
| 数据库 | SQLite | 轻量级嵌入式数据库 |
| 认证方式 | JWT | 无状态认证机制 |
| 文件存储 | 本地存储 | 简化部署复杂度 |

## 2. 系统架构

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    Universal Shop 系统架构                    │
├─────────────────────────────────────────────────────────────┤
│  客户端层 (Client Layer)                                      │
│  ┌─────────────────┐  ┌─────────────────┐                   │
│  │   用户门户        │  │   管理后台        │                   │
│  │  (Portal)        │  │   (Admin)       │                   │
│  │  Vue 3 + Vite   │  │  Vue 3 + Vite   │                   │
│  └─────────────────┘  └─────────────────┘                   │
├─────────────────────────────────────────────────────────────┤
│  网络层 (Network Layer)                                       │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │             HTTP/HTTPS + CORS                           │ │
│  └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│  服务层 (Service Layer)                                       │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                Express.js 服务器                         │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐      │ │
│  │  │   路由层     │ │  中间件层    │ │  控制器层    │      │ │
│  │  │  (Routes)   │ │ (Middleware)│ │(Controllers)│      │ │
│  │  └─────────────┘ └─────────────┘ └─────────────┘      │ │
│  └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│  业务逻辑层 (Business Layer)                                  │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                   Sequelize ORM                        │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐      │ │
│  │  │   用户模块   │ │   商品模块   │ │   订单模块   │      │ │
│  │  │   (User)    │ │  (Product)  │ │   (Order)   │      │ │
│  │  └─────────────┘ └─────────────┘ └─────────────┘      │ │
│  └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│  数据持久层 (Data Layer)                                      │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                    SQLite 数据库                         │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐      │ │
│  │  │   用户表     │ │   商品表     │ │   订单表     │      │ │
│  │  │  (users)    │ │ (products)  │ │  (orders)   │      │ │
│  │  └─────────────┘ └─────────────┘ └─────────────┘      │ │
│  └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│  文件存储层 (Storage Layer)                                   │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                   本地文件系统                           │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐      │ │
│  │  │   商品图片   │ │   用户头像   │ │   系统文件   │      │ │
│  │  │   上传目录   │ │   上传目录   │ │   备份目录   │      │ │
│  │  └─────────────┘ └─────────────┘ └─────────────┘      │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 模块化架构

#### 2.2.1 前端架构 (Vue 3)

```
src/
├── portal/                 # 用户门户端
│   ├── components/         # 可复用组件
│   ├── views/              # 页面组件
│   │   ├── Home.vue        # 首页
│   │   ├── product/        # 商品相关页面
│   │   ├── cart/           # 购物车相关页面
│   │   ├── order/          # 订单相关页面
│   │   └── user/           # 用户相关页面
│   ├── router/             # 路由配置
│   ├── stores/             # Pinia状态管理
│   ├── api/                # API接口封装
│   └── utils/              # 工具函数
├── admin/                  # 管理后台端
│   ├── components/         # 管理后台组件
│   ├── views/              # 管理页面
│   │   ├── Dashboard.vue   # 数据统计页面
│   │   ├── Products.vue    # 商品管理
│   │   ├── Orders.vue      # 订单管理
│   │   ├── Users.vue       # 用户管理
│   │   └── SystemConfig.vue # 系统配置
│   ├── router/             # 管理后台路由
│   └── stores/             # 管理员状态管理
└── config/                 # 配置管理
```

#### 2.2.2 后端架构 (Node.js + Express)

```
src/server/
├── config/                 # 配置文件
│   └── database.js         # 数据库配置
├── models/                 # 数据模型
│   ├── User.js             # 用户模型
│   ├── Product.js          # 商品模型
│   ├── Order.js            # 订单模型
│   ├── OrderItem.js        # 订单项模型
│   ├── Cart.js             # 购物车模型
│   ├── Address.js          # 地址模型
│   ├── Administrator.js    # 管理员模型
│   ├── OperationLog.js     # 操作日志模型
│   └── SystemConfig.js     # 系统配置模型
├── controllers/            # 控制器
│   ├── userController.js   # 用户业务逻辑
│   ├── productController.js# 商品业务逻辑
│   ├── orderController.js  # 订单业务逻辑
│   ├── cartController.js   # 购物车业务逻辑
│   └── ...                 # 其他控制器
├── routes/                 # 路由定义
│   ├── userRoutes.js       # 用户路由
│   ├── productRoutes.js    # 商品路由
│   ├── orderRoutes.js      # 订单路由
│   └── ...                 # 其他路由
├── middlewares/            # 中间件
│   ├── auth.js             # 认证中间件
│   └── adminAuth.js        # 管理员认证中间件
└── utils/                  # 工具函数
```

## 3. 核心模块设计

### 3.1 认证授权模块

#### 3.1.1 用户认证
- **认证方式**: JWT (JSON Web Token)
- **存储位置**: localStorage (前端) + 内存 (服务端验证)
- **过期时间**: 7天（可配置）
- **密码加密**: bcrypt (10轮加盐)

#### 3.1.2 管理员权限系统
- **角色分级**:
  - `super_admin`: 超级管理员（全部权限）
  - `admin`: 管理员（除操作日志外的所有权限）
  - `operator`: 操作员（基本功能权限）

- **权限控制**:
  - 前端：路由守卫 + 组件级权限控制
  - 后端：中间件验证 + 接口级权限检查

### 3.2 数据模型设计

#### 3.2.1 核心实体关系图

```
用户 (User)
├── 一对多 → 订单 (Order)
├── 一对多 → 购物车项 (Cart)
├── 一对多 → 收货地址 (Address)
└── 关联字段：推荐码系统

商品 (Product)
├── 一对多 → 购物车项 (Cart)
├── 一对多 → 订单项 (OrderItem)
└── 属性：分类、价格、库存、折扣

订单 (Order)
├── 多对一 → 用户 (User)
├── 一对多 → 订单项 (OrderItem)
└── 状态：pending → paid → shipped → delivered

管理员 (Administrator)
├── 角色：super_admin / admin / operator
├── 权限：基于角色的访问控制
└── 操作日志：记录所有管理操作
```

### 3.3 API接口设计

#### 3.3.1 RESTful API 规范

| 模块 | 端点前缀 | 说明 |
|------|----------|------|
| 用户认证 | `/api/auth` | 登录、注册、token验证 |
| 用户管理 | `/api/users` | 用户CRUD操作 |
| 商品管理 | `/api/products` | 商品CRUD操作 |
| 购物车 | `/api/cart` | 购物车操作 |
| 订单管理 | `/api/orders` | 订单CRUD操作 |
| 地址管理 | `/api/addresses` | 地址CRUD操作 |
| 文件上传 | `/api/upload` | 图片上传接口 |
| 管理后台 | `/api/admin` | 管理员专用接口 |
| 系统配置 | `/api/system-config` | 系统参数配置 |

#### 3.3.2 响应格式统一

```json
{
  "success": true,
  "message": "操作成功",
  "data": { ... },
  "pagination": {
    "page": 1,
    "pageSize": 20,
    "total": 100
  }
}
```

## 4. 部署架构

### 4.1 部署模式

#### 4.1.1 单机部署（推荐）
```
┌─────────────────────────────────────┐
│           Linux 服务器              │
├─────────────────────────────────────┤
│  ┌─────────────────────────────────┐│
│  │      Express.js 服务器          ││
│  │                                 ││
│  │  ┌─────────────┐ ┌─────────────┐││
│  │  │   静态文件   │ │  API 接口   │││
│  │  │   服务       │ │    服务     │││
│  │  │             │ │             │││
│  │  │  Portal +   │ │   REST API  │││
│  │  │   Admin     │ │             │││
│  │  └─────────────┘ └─────────────┘││
│  └─────────────────────────────────┘│
│                                     │
│  ┌─────────────────────────────────┐│
│  │        SQLite 数据库            ││
│  │     (本地文件存储)               ││
│  └─────────────────────────────────┘│
│                                     │
│  ┌─────────────────────────────────┐│
│  │         文件存储                ││
│  │    (uploads/ 目录)              ││
│  └─────────────────────────────────┘│
└─────────────────────────────────────┘
```

#### 4.1.2 HTTPS安全部署
- **SSL证书**: 自动生成自签名证书
- **端口配置**: 
  - HTTP: 3000 (重定向到HTTPS)
  - HTTPS: 3443
- **安全头**: Helmet.js提供安全防护
- **CORS配置**: 支持跨域请求

### 4.2 环境配置管理

#### 4.2.1 配置文件层级
```
环境变量(.env) → 配置文件(config/) → 默认值
```

#### 4.2.2 核心配置项
- **应用配置**: 端口、环境、应用名称
- **数据库配置**: SQLite路径、日志级别  
- **JWT配置**: 密钥、过期时间
- **文件上传**: 路径、大小限制、文件类型
- **系统配置**: 语言、货币、免邮费阈值

## 5. 性能与优化

### 5.1 前端优化
- **代码分割**: Vue Router懒加载
- **静态资源**: 版本化文件名 + 缓存策略
- **构建优化**: Vite生产模式优化
- **图片优化**: 支持WebP格式

### 5.2 后端优化
- **数据库索引**: 关键字段建立索引
- **查询优化**: 分页查询、条件筛选
- **缓存策略**: 静态资源缓存
- **压缩传输**: gzip压缩

### 5.3 部署优化
- **进程管理**: 支持后台运行
- **日志管理**: 结构化日志输出
- **健康检查**: `/api/health`端点
- **监控统计**: 操作日志记录

## 6. 安全架构

### 6.1 认证安全
- **密码策略**: bcrypt加密 + 10轮加盐
- **JWT安全**: 强随机密钥 + 过期机制
- **会话管理**: 无状态JWT认证

### 6.2 数据安全
- **输入验证**: Joi库进行数据校验
- **SQL注入防护**: Sequelize ORM参数化查询
- **XSS防护**: 前端输出转义
- **CSRF防护**: CORS配置限制

### 6.3 系统安全
- **文件上传**: 文件类型限制 + 大小控制
- **权限控制**: 基于角色的访问控制(RBAC)
- **操作审计**: 管理员操作日志记录
- **错误处理**: 统一错误处理，避免信息泄露

## 7. 监控与维护

### 7.1 日志系统
- **应用日志**: Winston结构化日志
- **访问日志**: Express请求日志
- **错误日志**: 异常捕获和记录
- **操作日志**: 管理员操作审计

### 7.2 健康监控
- **健康检查**: `/api/health`接口
- **数据库连接**: 连接状态检测
- **系统资源**: 内存、磁盘使用情况

## 8. 扩展性设计

### 8.1 水平扩展
- **数据库**: 可替换为MySQL/PostgreSQL
- **文件存储**: 可扩展至云存储服务
- **缓存系统**: 可集成Redis缓存

### 8.2 功能扩展
- **支付集成**: 预留支付网关接口
- **邮件服务**: 支持SMTP邮件发送
- **消息推送**: WebSocket预留接口
- **多租户**: 系统配置支持多商户

---

*最后更新时间: 2024年*
*版本: v1.0*
